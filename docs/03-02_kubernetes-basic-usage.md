# 3장. 컨테이너를 다루는 표준 아키텍처, 쿠버네티스

> 3.1 쿠버네티스 이해하기
> 3.2 쿠버네티스 기본 사용법 배우기
> 3.3 쿠버네티스 연결을 담당하는 서비스
> 3.4 알아두면 쓸모 있는 쿠버네티스 오브젝트
>
> 본 문서는 3장의 일부 내용 중 **3.2 쿠버네티스 기본 사용법 배우기** 중 일부를 정리한 내용입니다.

## 3.2쿠버네티스 기본 사용법 배우기

## 파드 생성 방법

- `run`으로 생성 시:  
  단일 파드 1개만 생성됨.

- `create deployment`로 생성 시:  
  디플로이먼트(Deployment)라는 관리 그룹 내에서 파드 생성됨.

> 쿠버네티스 1.18 이전: `run` 명령으로도 디플로이먼트 생성

---

## 오브젝트란?

파드와 디플로이먼트는 `spec`, `status` 등의 값을 가진 단위 → 이를 오브젝트라고 함.

### 기본 오브젝트

- **Pod**: 실행 최소 단위.  
  보통 1개의 컨테이너를 가짐. 독립 IP와 파일 시스템 제공.

- **Namespace**: 리소스 구분 관리용 그룹  
  - default  
  - kube-system  
  - metallb-system 등

- **Volume**: 파드 내에서 사용할 수 있는 디렉터리.  
  기본 파드는 휘발성이므로 볼륨으로 영속 저장 가능.

- **Service**: 파드 접속 정보를 고정하고 내·외부 연결을 지원함.

📌 참고: 157page, 그림 3-19 — 쿠버네티스 기본 오브젝트

---

## 디플로이먼트

- 파드를 효율적으로 관리하기 위한 상위 오브젝트
- 복제, 업데이트, 롤백 등 고급 기능 포함
- 기반은 파드

> 이외 오브젝트: DaemonSet, ReplicaSet, ConfigMap, PV/PVC, StatefulSet 등

---

## 레플리카셋으로 파드 수 관리

- 파드 수를 보장하는 역할
- 예: 3개 파드 선언 시, 컨트롤러 매니저 + 스케줄러가 클러스터에 3개 생성 유지

📌 참고: 163page, 그림 3-24 — 레플리카셋으로 파드 3개 생성

> 디플로이먼트를 통해 레플리카셋 포함한 관리 권장

---

## 오브젝트 스펙 파일

- `kubectl create deployment`로는 파드 1개만 생성됨  
  (replicas 설정 불가)

- 여러 파드를 만들고 싶으면 YAML로 작성한 오브젝트 **스펙 파일** 필요

---

## apply로 오브젝트 생성/관리

- `run`: 단순, 테스트용 단일 파드 생성  
- `create`: 단발성 생성, 변경 어려움  
- `apply`: 스펙 파일 기반으로 오브젝트 생성 및 변경 가능

> 오브젝트에 변경이 생길 수 있다면 **apply 사용 권장**

## 파드의 자동 복구(Self-Healing)

- 쿠버네티스는 파드 내 컨테이너가 비정상일 경우 자동으로 재시작하거나 교체하여 복구함
- 이와 같은 기능을 **셀프 힐링(Self-Healing)** 이라 함

> `kubectl exec` 명령에서 `--` 의 의미:  
> exec 명령과 컨테이너 내 실행할 명령어의 인자를 구분할 때 사용  
> 예: `kubectl exec -it my-pod -- /bin/bash`

---

## 파드의 동작 보장

- 쿠버네티스는 파드가 항상 동작하도록 보장하는 기능 제공
- 디플로이먼트에 속한 파드가 삭제될 경우, 설정된 `replicas` 수를 유지하기 위해 새 파드를 자동 생성함
- 반대로, **디플로이먼트에 속하지 않은 파드**는 수동으로 삭제 시 복구되지 않음

> ✅ 파드의 동작 보장을 위해 디플로이먼트를 사용하는 것이 권장됨  
> 상위 디플로이먼트를 삭제해야 관련된 파드가 함께 제거됨

---

## 노드 자원 보호하기

- 노드가 불안정하거나 장애 이력이 있을 경우, 해당 노드에 파드가 할당되지 않도록 설정 가능
- `kubectl cordon <노드명>` 명령을 통해 **스케줄링 비활성화(SchedulingDisabled)** 상태로 설정 가능
- 해당 노드에는 새 파드가 더 이상 할당되지 않음

---

## 노드 유지보수

- 노드를 유지보수(점검, 재시작 등)하기 전에 그 노드의 파드를 모두 안전하게 다른 노드로 옮길 필요가 있음
- `kubectl drain <노드명>` 명령 사용
  - 해당 노드의 파드들을 삭제하고 동일한 디플로이먼트/레플리카셋 기반으로 다른 노드에 재생성

> 💡 DaemonSet은 각 노드에 하나만 존재해야 하므로 `drain`으로 제거되지 않음  
> 이 경우 `--ignore-daemonsets` 옵션을 사용

---

## 파드 업데이트와 롤백

- 운영 중인 파드를 업데이트할 경우 새로운 이미지 배포나 버전 업그레이드가 필요할 수 있음
- `--record` 옵션: 디플로이먼트 변경 이력을 기록함  
- `kubectl describe` 명령: 배포 상태, 이벤트 등 디버깅 정보 확인 가능

