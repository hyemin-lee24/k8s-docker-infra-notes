## 3.3 쿠버네티스 연결을 담당하는 서비스

서비스는 외부에서 쿠버네티스 클러스터에 접속하는 방법이다.

------

### 노드 포트

노드포트 서비스는 모든 워커 노드의 특정 포트를 열고, 이 포트로 들어오는 모든 요청을 노드포트 서비스로 전달한다. 이후 해당 요청을 처리할 수 있는 파드로 전달된다.

> 참고: p.209 그림 2-25 노드포트 서비스 구성도

노드포트 서비스는 오브젝트 스펙 파일 또는 `expose` 명령어로 생성할 수 있다.

------

### 사용 목적별로 연결하는 인그레스

노드포트는 포트를 중복해서 사용할 수 없기 때문에 하나의 노드포트에 하나의 디플로이먼트만 적용할 수 있다.

여러 개의 디플로이먼트가 있을 경우, 그 수만큼 노드포트를 생성하는 방식 대신 인그레스를 사용한다.

인그레스는 고유한 주소를 제공하고, 사용 목적에 따라 다른 응답을 제공할 수 있다. 또한 트래픽에 대한 L4/L7 로드밸런서 역할과 보안 인증서를 처리하는 기능도 갖고 있다.

인그레스를 사용하려면 인그레스 컨트롤러가 필요하다.

인그레스 컨트롤러는 파드와 직접 통신할 수 없어서, 노드포트 또는 로드밸런서 서비스와 연동되어야 한다.

인그레스 컨트롤러의 목적은 사용자가 접속하는 경로에 따라 다른 결괏값을 제공하는 것이다.

> 참고: p.220 그림 3-41 NGINX 인그레스 컨트롤러 서비스 구성도

------

### 클라우드에서 쉽게 구성 가능한 로드밸런서

비효율적인 방식:

> 들어오는 요청을 모두 워커 노드의 노드포트를 통해 노드포트 서비스로 이동하고, 이를 다시 쿠버네티스의 파드로 보내는 구조

로드밸런서라는 서비스 타입을 사용하면 간단한 구조로 파드를 외부에 노출하고, 부하 분산이 가능하다.

> 참고: p.232 그림 3-48 로드밸런서 서비스 구성도

------

### 온프레미스에서 로드밸런서를 제공하는 MetalLB

온프레미스 환경에서 로드밸런서를 사용하려면 내부에서 로드밸런서 서비스를 받아주는 구성이 필요하다. 이를 지원하는 것이 MetalLB이다.

MetalLB는 베어메탈 환경의 쿠버네티스에서도 로드밸런서를 사용할 수 있게 고안되었다.

기존의 L2 네트워크와 L3 네트워크 방식으로 로드밸런서를 구현한다.

> 참고: p.234 그림 3-49

MetalLB 컨트롤러는 작동 방식을 정의하고 EXTERNAL-IP를 부여해 관리한다.

MetalLB 스피커는 정해진 작동 방식에 따라 경로를 만들 수 있도록 네트워크 정보를 광고하고 수집하여, 각 파드의 경로를 제공한다.

------

### 부하에 따라 자동으로 파드 수를 조절하는 HPA

HPA(Horizontal Pod Autoscaler)는 부하량에 따라 디플로이먼트의 파드 수를 유동적으로 관리하는 기능이다.

> 참고: p.245 그림 3-54 HPA 작동 구조